# Babylon Bitcoin Staking - Usage Guide

This document describes how to use the Bitcoin Staking
TypeScript library to generate the Bitcoin and Babylon Genesis
transactions associated with the Bitcoin staking protocol.
For a comprehensive review of the protocol for the registration
of Bitcoin stakes on the Babylon Genesis chain and the transactions involved,
please read the [stake registration
documentation](https://github.com/babylonlabs-io/babylon/blob/release/v1.x/docs/register-bitcoin-stake.md).

## Table of Contents

- [Babylon Bitcoin Staking - Usage Guide](#babylon-bitcoin-staking---usage-guide)
  - [Table of Contents](#table-of-contents)
  - [1. Prerequisites](#1-prerequisites)
    - [1.1 Staking Parameters](#11-staking-parameters)
    - [1.2 Bitcoin Staker information](#12-bitcoin-staker-information)
    - [1.3 Signing Providers](#13-signing-providers)
  - [2. Staking Manager Initialization](#2-staking-manager-initialization)
  - [3. Stake Registration](#3-stake-registration)
    - [3.1 Post-Staking Registration](#31-post-staking-registration)
    - [3.2 Pre-Staking Registration](#32-pre-staking-registration)
  - [4. Delegation Expansion](#4-delegation-expansion)
    - [4.1 Staking Expansion Registration](#41-staking-expansion-registration)
    - [4.2 Create Signed Staking Expansion Transaction](#42-create-signed-staking-expansion-transaction)
  - [5. Unbonding Transaction](#5-unbonding-transaction)
  - [6. Withdrawal Transaction](#6-withdrawal-transaction)
  - [7. Fee Calculation](#7-fee-calculation)
    - [7.1 Bitcoin Transaction Fee](#71-bitcoin-transaction-fee)
    - [7.2 Babylon Genesis Transaction Fee](#72-babylon-genesis-transaction-fee)

## 1. Prerequisites

### 1.1 Staking Parameters

The Bitcoin Staking parameters define the conditions
that the Bitcoin Staking script and the Bitcoin Staking
transaction containing it must satisfy.
They are versioned parameters, with each version corresponding
to a range of Bitcoin heights.

You can retrieve the parameters as follows:
* By querying the `/babylon/btcstaking/v1/params` endpoint
  of an RPC/LCD node. You can find the available RPC/LCD nodes
  of each active network in the
  [Babylon networks Information](https://docs.babylonlabs.io/developers/babylon_genesis_chain/node_information/).
* By querying the `/v2/network-info` endpoint of the
  [Babylon Staking API](https://docs.babylonlabs.io/api/staking-api/get-network-info/)
  that exposes the indexed Babylon parameters.

To learn more about the Bitcoin staking parameters and their usage in
constructing and validating Bitcoin Staking transactions, please refer to the
[specification](https://github.com/babylonlabs-io/babylon/blob/release/v1.x/docs/register-bitcoin-stake.md#32-babylon-chain-btc-staking-parameters).

> **Important**: The parameters are subject to change as they are controlled
> by Babylon Genesis governance. Please make sure that you understand how to
> select the correct parameters before creating your Bitcoin Staking
> transaction. Usage of the incorrect parameters might lead to (temporary or not)
> fund loss.

### 1.2 Bitcoin Staker information

**Staker's Bitcoin Details**

The staker's *Bitcoin address* serves two key purposes within this library:
- Acts as the change address when creating Bitcoin staking transactions
- Serves as the withdrawal address when creating Bitcoin withdrawal transactions

The staker's *Bitcoin public key* is essential throughout the creation of all
Bitcoin transactions as it is used to construct the tapscript.

> **Important**: The Bitcoin address should always correspond to the Bitcoin
> public key and be generated by it.

Staker inputs define the parameters for Bitcoin staking. Stakers can customize
their:
- Staking timelock duration
- Staking amount
- Selected finality providers for delegation

> **Note**: The other parameters included in the
> [Bitcoin Staking script](https://github.com/babylonlabs-io/babylon/blob/release/v1.x/docs/staking-script.md)
> are retrieved through the Bitcoin Staking parameters.

```ts
const stakerInfo = {
  // BTC Address
  address: string,
  // BTC compressed public Key in the 32-byte x-coordinate only hex format.
  publicKeyNoCoordHex: string,
}

const stakerInput = {
  // The chosen finality providers public keys in compressed 32 bytes x-coordinate
  // only format.
  finalityProviderPksNoCoordHex: string[],
  // Amount of satoshis staker choose to stake
  stakingAmountSat: number,
  // The number of BTC blocks this staking transaction will be staked for
  stakingTimelock: number
}
```

**Staker's Babylon Genesis Details**

The Babylon Genesis address specifies the address of the staker on the Babylon
Genesis blockchain. It is used as the signer of the 
Babylon Genesis transaction to register the stake and
to create the Proof of Possession (PoP),
which must be signed during the registration process.
The PoP is used to confirm the ownership of the Bitcoin key used for staking
by the Babylon Genesis account used for stake registration.

```ts
// Babylon bech32 address with prefix of `bbn`.
const babylonAddress = string
```

### 1.3 Signing Providers

A Provider is a construct that maintains a private key that can be used for
signing operations (e.g., a wallet).

For the purposes of this library, two providers are required:
- **Bitcoin Provider**: Responsible for signing Bitcoin transactions and
arbitrary messages through the ECDSA or BIP-322 algorithms.
- **Babylon Genesis Provider**: Responsible for signing Babylon Genesis
transactions. Babylon Genesis is based on Cosmos SDK, so providers that
support Cosmos SDK chains should be straightforward to adapt to Babylon Genesis.

Below we define the expected interface for both of the above providers.

```ts
export interface BtcProvider {
  // Sign a PSBT
  signPsbt(
    psbtHex: string,
    options?: SignPsbtOptions
  ): Promise<string>;
  // Sign a message using the ECDSA type
  // This is optional and only required if you would like to use the
  // `createProofOfPossession` function
  signMessage?: (
    message: string, type: "ecdsa" || "bip322-simple"
  ) => Promise<string>;
}

export interface BabylonProvider {
  // Signs a Babylon chain transaction.
  // This is primarily used for signing MsgCreateBTCDelegation transactions
  // which register the BTC delegation on the Babylon Genesis chain.
  signTransaction: <T extends object>(
    msg: {
      typeUrl: string;
      value: T;
    }
  ) => Promise<Uint8Array>
}
```

## 2. Staking Manager Initialization

To use the library, you'll need to create an instance
of `BabylonBtcStakingManager` with the following required parameters:

```ts
import { BabylonBtcStakingManager } from "@babylonlabs-io/btc-staking-ts";

const manager = new BabylonBtcStakingManager(
  btcNetwork,      // Bitcoin network configuration (mainnet or testnet)
  stakingParams,   // Staking parameters retrieved as described in Prerequisites
  btcProvider,     // Bitcoin Provider for signing Bitcoin transactions
  bbnProvider      // Babylon Provider for signing Babylon Genesis transactions
);
```

The manager instance provides the necessary methods for creating and
managing Bitcoin staking transactions. Make sure you have all the prerequisites
(staking parameters and providers) properly configured before initializing the
manager.

## 3. Stake Registration

The Bitcoin staker utilizes the staking inputs
(stake amount, timelock, finality providers) together
with the staking parameters to construct the necessary
transactiosn required by the Bitcoin Staking protocol.

These transactions include:
- BTC Staking Transaction: The Bitcoin transaction that locks the stake in
  the self-custodial Bitcoin staking script.
- Slashing Transaction: A pre-signed transaction consenting to slashing in
  case of double-signing.
- Unbonding Transaction: The on-demand unbonding transaction used to unlock
  the stake before the originally committed timelock expires.
- Unbonding Slashing Transaction: A pre-signed transaction consenting to
  slashing during the unbonding process in case of double-signing.

There are two types of registrations supported by Babylon Genesis chain in which
they fits for difference purpose/use-case:

- **Post-Staking Registration**: Should be used by stakers that already have
  their Bitcoin Staking transaction included in the Bitcoin ledger (e.g.,
  phase-1 stakers)
- **Pre-Staking Registration**: Can be used by stakers that prefer to receive
  the required stake verification guarantees before locking their funds on
  Bitcoin. This is the recommended method for staking for new Babylon Genesis
  stakes (i.e., ones created from phase-2 onwards).

For more details about the two types, refer to the
[Babylon node documentation](https://github.com/babylonlabs-io/babylon/blob/release/v1.x/docs/register-bitcoin-stake.md#2-bitcoin-stake-registration-methods).

> **Important**: Phase-1 stakers should always use the post-staking
> registration method to register their phase-1 stakes. For newly created
> phase-2 stakes, both methods can be used. 


### 3.1 Post-Staking Registration

This flow is for stakers who already have a confirmed BTC staking transaction
(`k`-blocks deep, where `k` is defined in the staking parameters)
and want to register it on the Babylon chain.
This process is particularly suitable for Babylon Phase-1 stakes.

The post-staking registration consists of multiple transactions and messages,
some requiring  signatures from the BTC Provider:
- Bitcoin staking transaction (already on the Bitcoin network) and a proof of
  inclusion
- Bitcoin unbonding transaction
- Bitcoin slashing transaction (**requires signing**)
- Bitcoin slashing unbonding transaction (**requires signing**)
- Proof of Possession (**requires signing**)

The final constructed message will be signed by the Babylon Provider as a 
Babylon Genesis transaction, ready for submission to the network.

```ts
const {
  signedBabylonTx
} = await manager.postStakeRegistrationBabylonTransaction(
  stakerInfo,
  stakingTx,
  stakingHeight,
  stakingInput,
  inclusionProof, 
  bech32Address,
);
```

### 3.2 Pre-Staking Registration

The Pre-staking registration flow is for stakers who seek verification from the
Babylon chain before submitting their BTC staking transaction to the Bitcoin
ledger. It is a multi-step process, involving:
1. The registration of the stake on the Babylon Genesis chain.
2. After verification is received, the submission of the signed Bitcoin
   staking transaction to the Bitcoin ledger.
3. Once the Bitcoin staking transaction has received sufficient confirmations,
   the Babylon Genesis chain is notified about its inclusion.

The registration to the Babylon Genesis blockchain
consists of the submission of multiple transactions and messages, some requiring 
signatures from the BTC Provider:
- Bitcoin staking transaction
- Bitcoin unbonding transaction
- Bitcoin slashing transaction (**requires signing**)
- Bitcoin slashing unbonding transaction (**requires signing**)
- Proof of Possession (**requires signing**)

First, we create the initial registration message that will be signed 
by the Babylon Provider as a Babylon Genesis transaction,
ready for submission to the network.

```ts
const {
  signedBabylonTx
} = await manager.preStakeRegistrationBabylonTransaction(
  stakerInfo,
  stakingInput,
  babylonBtcTipHeight,
  inputUTXOs,
  feeRate,
  bech32Address,
);
```

Next, we monitor for the transaction receiving verification by the Babylon
blockchain. We can do so by querying the Babylon node and checking for the
`VERIFIED` status as follows:
- By querying the `/babylon/btcstaking/v1/btc_delegation/:staking_tx_hash_hex`
  endpoint of an RPC/LCD node. For more details, see this
  [Babylon API documentation](https://docs.babylonlabs.io/api/babylon-gRPC/btc-delegation/).
- By queryign the `/v2/delegation?staking_tx_hash_hex=xxx` endpoint from the
  Babylon Staking API. For more details, see this
  [Staking API documentation](https://docs.babylonlabs.io/api/staking-api/get-a-delegation/).

After the stake has been marked as verified by the Babylon Genesis chain,
we can construct the Bitcoin Staking transaction that is ready to be
broadcast to the Bitcoin ledger.
```ts
const signedBtcStakingTx = await manager.createSignedBtcStakingTransaction({
  stakerInfo,
  stakingInput,
  unsignedStakingTx,
  inputUTXOs,
  stakingParamsVersion
})
```

Once the staking transaction has been included in the Bitcoin ledger with
sufficient confirmations, an off-chain program called the
[vigilante BTC Staking tracker](https://github.com/babylonlabs-io/vigilante)
notifies the Babylon chain about the staking transaction's inclusion.

## 4. Delegation Expansion

Delegation expansion allows you to extend an existing BTC stake with additional
finality providers or renew the timelock without going through the full unbonding
process. For more details, please refer to the
[BTC Stake Expansion](https://github.com/babylonlabs-io/babylon/blob/v3.0.0-rc.1/docs/bitcoin-stake-expansion.md).

The expansion process involves:
1. Creating an unsigned staking expansion transaction
2. Registering the expansion on the Babylon Genesis chain
3. Signing and submitting the expansion transaction to Bitcoin

### 4.1 Staking Expansion Registration

First, create the initial expansion registration message that will be signed
by the Babylon Provider as a Babylon Genesis transaction.

```ts
const {
  signedBabylonTx,
  stakingTx: stakingExpansionTx
} = await manager.stakingExpansionRegistrationBabylonTransaction(
  stakerInfo,
  stakingInput,
  babylonBtcTipHeight,
  inputUTXOs,
  feeRate,
  babylonAddress,
  {
    stakingTx: previousStakingTx,
    paramVersion: previousStakingParamsVersion,
    stakingInput: previousStakingInput,
  }
);
```

**Important Notes:**
- The expansion amount must equal the previous staking amount (increases are
not yet supported).
- All finality providers from the previous staking must be included in the
expansion. You can retrieve the previous staking information through the
`/v2/delegation?staking_tx_hash_hex=xxx` endpoint from the Babylon Staking API.
- The input UTXOs are used only to cover transaction fees, not to increase
the staking amount (this feature is not yet supported). The method
automatically selects the optimal UTXO to cover the fees.

### 4.2 Create Signed Staking Expansion Transaction

After the expansion has been registered and verified by the Babylon chain,
you can create the signed staking expansion transaction. This requires
covenant signatures from the covenant committee.

You can retrieve the covenant expansion signatures through either:
- By querying the `/babylon/btcstaking/v1/btc_delegation/:staking_tx_hash_hex`
  endpoint of an RPC/LCD node
- By querying the `/v2/delegation?staking_tx_hash_hex=xxx` endpoint from the
  Babylon Staking API

```ts
const signedStakingExpansionTx = await manager.createSignedBtcStakingExpansionTransaction(
  stakerInfo,
  stakingInput,
  unsignedStakingExpansionTx,
  inputUTXOs,
  stakingParamsVersion,
  {
    stakingTx: previousStakingTx,
    paramVersion: previousStakingParamsVersion,
    stakingInput: previousStakingInput,
  },
  covenantStakingExpansionSignatures
);
```

The resulting transaction is ready to be submitted to the Bitcoin network.

## 5. Unbonding Transaction

This step allows stakers to unbond their active staking transactions on demand
before the committed timelock expires. After unbonding, the funds will become
available for withdrawal once the unbonding period
(specified in the staking parameters) has elapsed.

The unbonding transaction requires signatures from both the staker and the
covenant committee. This step combines these signatures to create a complete
transaction ready for submission to the Bitcoin network.

You can retrieve the unsigned unbonding transaction and covenant committee
signatures through either:
- By querying the `/babylon/btcstaking/v1/btc_delegation/:staking_tx_hash_hex`
  endpoint of an RPC/LCD node. For more details, see this
  [Babylon API documentation](https://docs.babylonlabs.io/api/babylon-gRPC/btc-delegation/).
- By queryign the `/v2/delegation?staking_tx_hash_hex=xxx` endpoint from the
  Babylon Staking API. For more details, see this
  [Staking API documentation](https://docs.babylonlabs.io/api/staking-api/get-a-delegation/).

```ts
const { signedUnbondingTx } = await manager.createSignedBtcUnbondingTransaction({
  stakerInfo,
  stakingInput,
  stakingParamsVersion,
  stakingTx,
  unsignedUnbondingTx,
  covenantUnbondingSignatures
})
```

## 6. Withdrawal Transaction

There are 3 different types of withdrawal transactions:
1. Withdraw from early unbonding (`createSignedBtcWithdrawEarlyUnbondedTransaction`)
   - Used when the unbonding period has passed
2. Withdraw from expired timelock (`createSignedBtcWithdrawStakingExpiredTransaction`)
   - Used when the staking period has naturally ended
3. Withdraw from slashed stake (`createSignedBtcWithdrawSlashingTransaction`)
   - Used when withdrawing slashed funds after timelock expiry

All withdrawal transactions will direct the change balance to the staker's
address (provided via `stakerInfo`).
For more customized transaction options,
please refer to the [advanced usage documentation](docs/advanced-btc-tx.md).

The required input transaction varies depending on the withdrawal method:
- Early unbonding withdrawal requires the unbonding transaction
- Timelock expiry withdrawal requires the staking transaction
- Slashed stake withdrawal requires the slashing transaction

You can retrieve the Bitcoin staking transaction, unsigned unbonding transaction
, slashing transaction and staking input made at the time of creating the staking
transaction through either:
- By querying the `/babylon/btcstaking/v1/btc_delegation/:staking_tx_hash_hex`
  endpoint of an RPC/LCD node. For more details, see this
  [Babylon API documentation](https://docs.babylonlabs.io/api/babylon-gRPC/btc-delegation/).
- By queryign the `/v2/delegation?staking_tx_hash_hex=xxx` endpoint from the
  Babylon Staking API. For more details, see this
  [Staking API documentation](https://docs.babylonlabs.io/api/staking-api/get-a-delegation/).


```ts
// 1. Withdraw from early unbonding (when unbonding period has passed)
const signedWithdrawEarlyUnbondedTx = await manager.createSignedBtcWithdrawEarlyUnbondedTransaction({
  stakerInfo,
  stakingInput,
  stakingParamsVersion,
  unbondingTx, // Withdraw from unbonding transaction
  feeRate
})

// 2. Withdraw from expired timelock (when staking period has naturally ended)
const signedWithdrawTimelockExpiredTx = await manager.createSignedBtcWithdrawStakingExpiredTransaction({
  stakerInfo,
  stakingInput,
  stakingParamsVersion,
  stakingTx, // Withdraw from staking transaction
  feeRate
})

// 3. Withdraw from slashed Bitcoin Staking transaction (after timelock expiry)
const signedWithdrawSlashedTx = await manager.createSignedBtcWithdrawSlashingTransaction({
  stakerInfo,
  stakingInput,
  stakingParamsVersion,
  slashingTx, // Withdraw from slashing transaction
  feeRate
})
```

## 7. Fee Calculation

### 7.1 Bitcoin Transaction Fee

The library's fee calculation for Bitcoin transactions is based on an estimated
size of the transaction in virtual bytes (vB). This estimation helps in
calculating the appropriate fee to include in the transaction to ensure it is
processed by the Bitcoin network efficiently.

> **Note**: The fee estimation is only used for transactions in which the
> protocol allows to specify a custom fee, i.e., the staking and withdrawal
> transactions. The slashing and unbonding transactions have a pre-defined fee
> amount that should be used based on the Bitcoin Staking parameters utilized
> for the staking operation. Please refer to the
> [staking registration documentation](https://github.com/babylonlabs-io/babylon/blob/release/v1.x/docs/register-bitcoin-stake.md)
> for more details.

```ts
// Calculate the estimated fee for a staking transaction
const feeSats = manager.estimateBtcStakingFee({
  stakerInfo,
  babylonBtcTipHeight,
  stakingInput,
  inputUTXOs,
  feeRate
})
```

### 7.2 Babylon Genesis Transaction Fee

The current version of the library does support functionality for calculating
the Babylon Genesis transaction fees for the `pre-staking registration`
and `post-staking registration` operations. This feature will be added in a
future release.
For now please refer to the
[simple-staking example](https://github.com/babylonlabs-io/simple-staking/blob/main/src/app/hooks/client/rpc/mutation/useBbnTransaction.ts#L27). 
